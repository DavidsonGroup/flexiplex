on: [push]

jobs:
  build-linux:
    name: build-linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build
        uses: docker://ghcr.io/olliecheng/images:cross-x86-centos
        with:
          args: make

      - name: Add execute permission
        run: sudo chown runner:runner ./flexiplex && chmod +x ./flexiplex

      - name: Run tests
        run: make test

      - name: Tar files
        run: tar -cvf ./result.tar ./flexiplex

      - name: Get short SHA
        id: vars
        run: git config --global --add safe.directory '*' && echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.vars.outputs.sha_short }}-centos-7
          path: ./result.tar
          retention-days: 90

  build-macos:
    name: build-macos
    runs-on: macos-15
    env:
      CXX: g++-14
      CFLAGS: "-Wl,-rpath,/opt/homebrew/opt/gcc/lib/gcc/current -Wl,-install_name,/opt/homebrew/opt/gcc/lib/gcc/current/libstdc++.6.dylib \"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run make
        run: make

      - name: Add execute permission
        run: chmod +x ./flexiplex

      - name: Run tests
        run: make test

      - name: Tar files
        run: tar -cvf ./result.tar ./flexiplex

      - name: Get short SHA
        id: vars
        run: git config --global --add safe.directory '*' && echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.vars.outputs.sha_short }}-macos
          path: ./result.tar
          retention-days: 90
